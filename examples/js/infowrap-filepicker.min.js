/*! infowrap-filepicker - v0.3.9 - 2015-10-07
 * http://dev.infowrap.com/code/angular/angular-filepicker
 * Copyright (c) 2015 Infowrap;
 * Licensed MIT
 */
var infowrapFilepicker;infowrapFilepicker=angular.module("infowrapFilepicker",[]),infowrapFilepicker.config(["$provide",function(a){return a.decorator("$rootScope",["$delegate",function(a){return a.safeApply=function(b){var c;return c=a.$$phase,"$apply"!==c&&"$digest"!==c?a.$apply(b):b&&"function"==typeof b?b():void 0},a}])}]),infowrapFilepicker.provider("fpConfig",function(){var a,b,c,d;return a=void 0,b=!1,d=!1,c={},{setApiKey:function(b){return a=b},setDebug:function(a){return b=a},setSecurity:function(a){return d=a},setOptions:function(a){return c=a||{}},$get:function(){var e;return e={},e.apiKey=function(){return a},e.debug=function(){return b},e.security=function(){return d},e.options=function(){return c},e}}}),infowrapFilepicker.provider("infowrapFilepickerService",function(){return{$get:["fpConfig","infowrapFilepickerSecurity","$log","$window","$q","$rootScope","$timeout",function(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p;return i={},i.loadFilepicker=function(){var b,c,f;return f=e.defer(),c=a.options().loadProtocol||"",$("body").append('<script type="text/javascript" src="'+c+'//api.filepicker.io/v2/filepicker.js"></script>'),b=function(){return _.isUndefined(d.filepicker)?g(function(){return b()},50):f.resolve()},b(),f.promise},i.log=function(b,d){return a.debug()?d?c[d](b):c.log(b):void 0},i.events={},l="infowrapFilepicker",j=["pick","pickAndStore","exportFile","read","stat","write","writeUrl","store","convert","remove"],m=["pickedFiles","error","readingFiles","readingFilesComplete","readVCard","readProgress","resetFilesUploading","progress","storeProgress","writeUrlProgress","uploadProgress","uploadsComplete"],h=j.concat(m),n=["close"],i.events.modal={},_.forEach(n,function(a){return i.events.modal[a]=""+l+":modal:"+a}),_.forEach(h,function(a){return i.events[a]=""+l+":"+a,_.contains(j,a)?i[a]=function(){return i.log(""+a+" needs implementation!","error")}:void 0}),k={container:"modal",maxSize:5242880},o=_.extend(k,a.options().pickOptions),p=function(a){var b;return a=a||{},a.multiple=a.hasOwnProperty("multiple")?a.multiple:!0,b=_.clone(o,!0),_.extend(b,a),b},i.positionModal=function(){var b,c,e,f,g,h,i,j,k;return a.options().iframeContainer?(b=$("#"+a.options().iframeContainer),c=angular.element(d),e=c.outerHeight(!0),a.options().isMobile?(i=g=0,k="100%",f=""+(e+60)+"px"):(j=c.outerWidth(!0),k=""+j+"px",f=""+e+"px",i=50,g=j/2-b.width()/2,0>g&&(g=0)),h={top:""+i+"px",left:""+g+"px"},a.options().isMobile&&_.extend(h,{width:k,height:f}),b.css(h)):void 0},i.modalToggle=function(b){var c,e,h,j,k;return h=_.isUndefined(b)?!f.filepickerModalOpen:b,f.filepickerModalOpen=h,f.safeApply(),j=function(a){return 27===a.which&&(a.preventDefault(),f.filepickerModalOpen)?f.safeApply(function(){return i.modalToggle(!1)}):void 0},k=function(a){return f.filepickerModalOpen?i.positionModal():void 0},c=angular.element("body"),e=angular.element(d),h?(c.bind("keydown",j),e.bind("resize",k),g(function(){return e.scrollTop(0)},a.options().isMobile?300:0)):(c.unbind("keydown",j),e.unbind("resize",k))},i.pick=function(a){var b,c,d;return b=e.defer(),a=p(a),i.log(a),i.modalToggle(!0),d=function(a){return f.safeApply(function(){return i.modalToggle(!1),b.resolve(a)})},c=function(a){return i.log(a),f.safeApply(function(){return i.modalToggle(!1),b.reject(a)})},a.multiple?filepicker.pickMultiple(a,d,c):filepicker.pick(a,d,c),g(function(){return i.positionModal()},0),b.promise},i.pickAndStore=function(a){var b,c,d,h;return b=e.defer(),a=p(a),i.log(a),i.modalToggle(!0),d=function(a){return f.safeApply(function(){return i.modalToggle(!1),b.resolve(a)})},c=function(a){return i.log(a),f.safeApply(function(){return i.modalToggle(!1),b.reject(a)})},h={location:"S3",path:a.path},filepicker.pickAndStore(a,h,d,c),g(function(){return i.positionModal()},0),b.promise},i.writeUrl=function(a,b,c){var d,g;return g=e.defer(),c=c||{},d=_.first(b.split("?")),i.log(d),filepicker.writeUrl(a,d,c,function(a){return f.safeApply(function(){return g.resolve(a)})},function(a){return i.log(a),f.safeApply(function(){return g.reject(a)})}),g.promise},i.store=function(c,d){var g,h,j,k;return h=e.defer(),k=function(b){var e,g;return g={input:c},e={location:"S3"},a.security()?(e.policy=b.encoded_policy,e.signature=b.signature,e.path=b.policy.path):e.path=d.path,d.base64encode&&(e.base64decode=!0),d.filename&&(e.filename=d.filename),d.mimetype&&(e.mimetype=d.mimetype),filepicker.store(c,e,function(a){return _.extend(g,{data:a}),f.safeApply(function(){return h.resolve(g)})},function(a){return i.log(a),_.extend(g,{error:a}),f.safeApply(function(){return h.reject(g)})})},a.security()?(g=b.getCachedPolicy({"new":!0}),g?k(g):(j={"new":!0},d.wrapId?j.wrapId=d.wrapId:d.signType&&(j.signType=d.signType),b.sign(j).then(function(a){return k(a)}))):k(),h.promise},i.storeUrl=function(a,c){var d,g,h,j;return g=e.defer(),j=function(b){var d,e;return e={input:a},d={policy:b.encoded_policy,signature:b.signature,path:b.policy.path,location:"S3"},c.filename&&(d.filename=c.filename),filepicker.storeUrl(a,d,function(a){return _.extend(e,{data:a}),f.safeApply(function(){return g.resolve(e)})},function(a){return i.log(a),_.extend(e,{error:a}),f.safeApply(function(){return g.reject(e)})})},d=b.getCachedPolicy({"new":!0}),d?j(d):(h={"new":!0},c.wrapId?h.wrapId=c.wrapId:c.signType&&(h.signType=c.signType),b.sign(h).then(function(a){return j(a)})),g.promise},i["export"]=function(a,c,d,g){var h;return h=e.defer(),c=c||{},b.sign({id:a.id,"new":!0}).then(function(){var d,e;return d=b.cachedPolicies["new"],e={policy:d.encoded_policy,signature:d.signature},c=_.extend(c,e),filepicker.exportFile(a.url.url,c,function(a){return f.safeApply(function(){return h.resolve(a)})},function(a){return i.log(a),f.safeApply(function(){return h.reject(a)})})}),h.promise},i.read=function(a,c){var d,g,h,j,k,l;return d=e.defer(),c=c||{base64encode:!0},l=c.base64encode,h=function(e){var g,h;return i.log("filepicker.read: "+e),g=b.cachedPolicies.existing,_.extend(c,{policy:g.encoded_policy,signature:g.signature}),h={input:a},filepicker.read(e,c,function(a){return l&&(a="data:image/png;base64,"+a),_.extend(h,{data:a}),f.safeApply(function(){return d.resolve(h),f.$broadcast(i.events.read,h)})},function(a){return i.log(a),_.extend(h,{error:a}),f.safeApply(function(){return d.reject(h)})})},g=function(a,b){var c;return c=a,_.isObject(a)&&(b&&_.isNumber(a.id)&&_.extend(b,{id:a.id}),c=_.isObject(a.url)?a.url.url:a.url),b&&-1===c.indexOf("policy")&&_.extend(b,{handle:c}),c},j={},k=g(a,j),b.sign(j).then(function(){return h(k)}),d.promise},i.previewTargetLoad=function(){var a;return i.dropDomId?(a=$("#"+i.dropDomId),a.addClass("loading-image")):void 0},i.previewTargetReady=function(a,b){var c,d,e,f,h;return c=$("#"+i.dropDomId),e=c.data("field-name"),d=void 0,d=a.data.replace(/\n/g,""),b||(h=document.createElement("image"),h.onload=function(){return g(function(){return c.removeClass("loading-image"),c.css({"background-image":"url("+d+")"})},100),h.src=""},h.src=d),f={fieldName:e,data:_.extend(a.input,{id:_.uniqueId()})}},i.readVCardData=function(a){var b;return b=e.defer(),a&&i.read(a,{asText:!0}).then(function(a){var c;return c={data:vCard.initialize(a.data),input:a.input},b.resolve(c),f.$broadcast(i.events.readVCard,c)}),b.promise},i.readFiles=function(a,b,c){var d,e,g;return c||f.$broadcast(i.events.readingFiles),i.dropTargetField||(b?(i.log("--------\nDropped on specific zone target!"),i.log(b),i.log("for: "+b.data("for"))):(d=0,e=function(){return d++,d<a.length?g():(f.$broadcast(i.events.readingFilesComplete),f.safeApply())},(g=function(){var b,c,g,h;switch(b=a[d],c=b.name||b.filename,g="file_asset"!==b.type?b.type||b.mimetype||b.mime_type:b.mime_type,h={input:b},i.log("---------\nReading file:"),i.log(c+(" ("+g+")")),g.search(/image\/(gif|jpeg|png|tiff)/)>-1&&(g="image"),g){case"text/directory":return i.readVCardData(b).then(function(){return e()});case"image":return i.read(b).then(function(){return e()});case"text/plain":return e(),f.$broadcast(i.events.read,_.extend(h));case"application/pdf":return e(),f.$broadcast(i.events.read,_.extend(h))}})())),f.safeApply()},i.addToFilesUploading=function(a){return i.filesUploading=i.filesUploading.concat(_.flatten(a)),_.forEach(i.filesUploading,function(a){return a.id=_.uniqueId(a.name||a.filename)})},i.setUploadProgress=function(a){var b;return b=Math.floor(a),i.log("Uploading ("+b+"%)"),i.uploadProgress=b,i.uploadProgressStyle={width:b+"%"},b>25?g(function(){var a,c,d;return a=$(".file-status"),d=a.find(".upload-percentage").width(),c=d-Math.floor(d*(.01*b)),a.find(".upload-percent-text").css({right:c+12+"px"})},200):void 0},i.uploadProgressClasses=function(){return i.filesUploading.length?"progress-striped active":"progress-info"},i.addToFilesUploaded=function(a){return i.filesUploaded=i.filesUploaded.concat(_.flatten(a)),_.forEach(i.filesUploaded,function(a){return a.hasOwnProperty("created_at")?void 0:a.created_at=JSON.parse(JSON.stringify(new Date))}),i.filesUploading=[],f.uploadsInProgress=!1},i.clearFilesUploaded=function(){return i.filesUploaded=[]},i.resetFileStatus=function(){return f.uploadsInProgress=!1,i.usedFilePickerDialog=!1,i.dropDomId=void 0,i.dropTargetId=void 0,i.dropTargetParentId=void 0,i.dropTargetType=void 0,i.dropTargetField=void 0,i.dropWindow=void 0,i.uploadProgress=0,i.uploadProgressStyle={width:"0px"},i.filesUploading=i.filesUploaded=[]},i.resetFileStatus(),i}]}}),infowrapFilepicker.provider("infowrapFilepickerSecurity",function(){return{$get:["fpConfig","$log","$q","$rootScope","$http",function(a,b,c,d,e){var f,g,h;return h=!1,g=function(a){return a?f.operations["new"]:f.operations.existing},f={},f.cachedPolicies={"new":{},existing:{},types:{}},f.operations={"new":["pick","store","storeUrl"],existing:["read","stat","convert","write","writeUrl"]},f.getCachedPolicy=function(a){var b,c,d,e;return a=a||{},_.isUndefined(a.signType)?b=f.cachedPolicies[a["new"]?"new":"existing"]:(b=f.cachedPolicies.types[a.signType],b&&(b=f.cachedPolicies.types[a.signType][a["new"]?"new":"existing"])),b&&b.policy&&(d=g(a["new"]),c=_.find(b.policy.call,function(a){return _.contains(d,a)}),c&&b.policy.expiry&&(e=Math.floor((new Date).getTime()/1e3),e<=Number(b.policy.expiry)))?b:!1},f.sign=function(i){var j,k,l,m;return i=i||{},k=c.defer(),m={options:{call:g(i["new"])}},i.id&&_.extend(m.options,{file_id:i.id}),i.handle&&_.extend(m.options,{handle:i.handle.substr(i.handle.lastIndexOf("/")+1)}),i.size&&_.extend(m.options,{file_size:i.size}),j=d.activeWrap?d.activeWrap.id:void 0,i.resourceId=i.wrapId||j,"account"===i.signType&&(i.resourceId=i.signTypeResourceId||d.currentUser.id),h||(h=!0,l=function(c){var e,f,g,h,i;if(b.log("--- filepicker security sign ERROR ---"),"filenotfound"===c&&a.debug()&&b.log(c),a.options().errorHandling){for(h=a.options().errorHandling,i=[],f=0,g=h.length;g>f;f++)e=h[f],_.contains(e.msgs,c)?i.push(d.$emit(e.eventName,{data:{error:c}})):i.push(void 0);return i}},e.post(a.options().signApiUrl(i.resourceId,i.signType),m).success(function(c){var d,e;return h=!1,c&&c.error?(l(c.error),k.reject(c.error)):(a.debug()&&(b.log("--- filepicker security sign ---"),b.log(m.options.call)),e=function(){var a;return a=f.cachedPolicies.types[i.signType],_.isUndefined(a)&&(f.cachedPolicies.types[i.signType]={}),f.cachedPolicies.types[i.signType][i["new"]?"new":"existing"]=c},d=function(){return i["new"]?_.isUndefined(i.signType)?f.cachedPolicies["new"]=c:e():_.isUndefined(i.signType)?f.cachedPolicies.existing=c:e()},k.resolve(d()))}).error(function(a){return h=!1,a&&a.error&&l(a.error),k.reject(a.error)})),d.safeApply(),k.promise},f.secureForReading=function(a,b){var d,e,g;return d=c.defer(),e=0,g=function(){var c,h;return c=a[e],h={},b&&b.id?h.id=c.id:h.handle=_.isObject(c.url)?c.url.url:c.url,b.signType&&(h.signType=b.signType),b.signTypeResourceId&&(h.signTypeResourceId=b.signTypeResourceId),f.sign(h).then(function(){var b,i;return i=_.isUndefined(h.signType)?f.cachedPolicies.existing:f.cachedPolicies.types[h.signType].existing,b="?signature="+i.signature+"&policy="+i.encoded_policy,_.isObject(c.url)?c.url.url+=b:c.url+=b,e++,e===a.length?d.resolve(a):g()})},g(),d.promise},f}]}}),infowrapFilepicker.run(["fpConfig","infowrapFilepickerService","$rootScope","$window",function(a,b,c,d){return a.apiKey()?b.loadFilepicker().then(function(){return d.filepicker.setKey(a.apiKey())}):b.log("apiKey is required!","error"),c.filepickerModalOpen=!1,c.filepickerModalClose=function(){return b.modalToggle(!1)},c.$on("$routeChangeSuccess",function(){return b.modalToggle(!1)}),c.$on(b.events.modal.close,function(){return b.modalToggle(!1)})}]),infowrapFilepicker.directive("filepickerBtn",["fpConfig","infowrapFilepickerService","infowrapFilepickerSecurity","$timeout","$rootScope",function(a,b,c,d,e){var f;return f=function(d,f,g){var h,i;return _.isUndefined(d.processWhen)||d.processWhen?(i=function(g){var h,i,j,k;return _.isArray(g)||(g=[g]),b.resetFileStatus(),d.previewOnUpload?(d.previewTarget&&(k=f.closest(d.previewTarget),h=k.length?k:f.siblings(d.previewTarget),b.dropDomId=h.attr("id"),b.dropTargetType=h.data("target-type")),b.usedFilePickerDialog=!0,d.preventDefault?(i=function(a){return e.$broadcast(b.events.pickedFiles,a,d.targetType)},a.security()?(j={wrapId:d.targetParentId,signType:d.signType,signTypeResourceId:d.signTypeResourceId},c.secureForReading(g,j).then(i)):i(g)):(b.addToFilesUploading(g),b.readFiles(g))):d.storeLocation&&e.$broadcast(b.events.store,{data:g,targetId:d.targetId,targetParentId:d.targetParentId,targetType:d.targetType}),e.safeApply()},h=function(f){var g,h,j,k;return j=function(c){var f,g;return f=a.security()?{policy:c.encoded_policy,signature:c.signature,path:c.policy.path}:{},d.mimeTypes&&_.extend(f,{mimetypes:d.mimeTypes.split(",")}),"false"===d.multiple&&_.extend(f,{multiple:!1}),d.maxSize&&_.extend(f,{maxSize:Number(d.maxSize)}),d.services?_.extend(f,{services:d.services.split(",")}):_.extend(f,a.options().pickOptions),f.imageQuality=80,a.options().isMobile?f.imageMax=[800,800]:f.imageMax=[1500,1500],g=function(a){return b.log(a),i(_.isArray(a)?a:[a])},e.safeApply(function(){return d.storeLocation?b.pickAndStore(f).then(g):b.pick(f).then(g)})},a.security()?(h={"new":!0,signType:d.signType},g=c.getCachedPolicy(h),g?j(g):(k={"new":!0,wrapId:d.targetParentId,signType:d.signType,signTypeResourceId:d.signTypeResourceId},e.safeApply(function(){return c.sign(k).then(function(a){return j(a)})}))):j()},f.bind("click",h)):void f.remove()},{restrict:"A",scope:{closeModalOnOpen:"@",btnClass:"@",dragAndDrop:"@",icon:"@",ignoreReadSigning:"@",mimeTypes:"@",maxSize:"@",multiple:"@",preventDefault:"@",previewOnUpload:"@",previewTarget:"@",processWhen:"=?",services:"@",signType:"@",signTypeResourceId:"@",storeLocation:"@",targetId:"=?",targetParentId:"=?",targetType:"@",text:"@"},replace:!0,transclude:!0,template:"<div data-ng-transclude></div>",link:f}}]);